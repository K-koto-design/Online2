<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö-–û–Ω–ª–∞–π–Ω –ë–∞–Ω–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ö-–û–Ω–ª–∞–π–Ω">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --bg-main: #f0f4f8;
            --grad-red: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --grad-pay: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --radius-card: 28px;
            --radius-btn: 22px;
            --anim-fast: 0.3s ease;
            --anim-screen: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-main); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
            -webkit-font-smoothing: antialiased; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* –°–Ω–µ–≥ */
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { 
            display: none; position: absolute; inset: 0; 
            overflow-y: auto; background: var(--bg-main); 
            z-index: 10; opacity: 0; transform: scale(0.96); 
            transition: opacity var(--anim-screen), transform var(--anim-screen); 
        }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }

        /* –®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .header-top { background: var(--grad-red); padding: 70px 0 45px; border-radius: 0 0 50px 50px; color: white; position: relative; z-index: 11; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .user-meta { display: flex; justify-content: space-between; align-items: center; padding: 0 25px; margin-bottom: 25px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤ —à–∞–ø–∫–µ */
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .h-btn { 
            width: 48px; height: 48px; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 22px; cursor: pointer; transition: transform 0.2s active;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .h-btn:active { transform: scale(0.9); }
        .btn-qr { background: var(--grad-pay); }
        .btn-history { background: rgba(255,255,255,0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }

        /* –ê–≤–∞—Ç–∞—Ä */
        .ava-box { 
            width: 60px; height: 60px; background: rgba(255,255,255,0.1); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 800; font-size: 24px; border: 2px solid rgba(255,255,255,0.2); 
            position: relative; 
        }
        .santa-hat { position: absolute; top: -20px; left: -14px; font-size: 32px; transform: rotate(-15deg); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±–∞–ª–∞–Ω—Å–∞ */
        .cards-slider { display: flex; overflow-x: auto; padding: 10px 25px 30px; gap: 18px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .cards-slider::-webkit-scrollbar { display: none; }
        .card-item { 
            min-width: 230px; height: 140px; border-radius: var(--radius-card); 
            padding: 25px; display: flex; flex-direction: column; justify-content: space-between; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); flex-shrink: 0;
            transition: transform 0.3s;
        }
        .card-main { background: linear-gradient(160deg, #1a1a1a 0%, #000000 100%); color: white; }
        .card-usd { background: linear-gradient(160deg, #002f6c 0%, #001433 100%); color: white; }
        .card-gold { background: linear-gradient(160deg, #d4af37 0%, #f1c40f 100%); color: #4a3b00; }

        /* –í–∏–¥–∂–µ—Ç—ã/–ú–µ–Ω—é */
        .menu-section { padding: 15px 25px; }
        .menu-item { 
            background: #fff; border-radius: 25px; padding: 20px; 
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.04); cursor: pointer;
            transition: background 0.2s;
        }
        .menu-item:active { background: #f9f9f9; }
        .m-icon { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px; }

        /* –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */
        .hist-container { padding: 0 25px 100px; }
        .hist-row { 
            background: #fff; padding: 18px; border-radius: 22px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .hist-info b { display: block; font-size: 16px; margin-bottom: 4px; }
        .hist-info span { font-size: 12px; color: #aaa; }
        .hist-val { font-weight: 800; font-size: 17px; }
        .val-plus { color: #27ae60; }
        .val-minus { color: #000; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
        .form-group { padding: 30px 25px; }
        input, textarea { 
            width: 100%; height: 65px; border-radius: 20px; border: 1px solid #eee; 
            padding: 0 20px; font-size: 17px; margin-bottom: 15px; 
            background: #f9f9f9; font-family: inherit; transition: border 0.2s;
        }
        input:focus { border-color: #007aff; background: #fff; }
        .btn-action { 
            width: 100%; height: 65px; border: none; border-radius: 24px; 
            font-size: 18px; font-weight: 700; cursor: pointer; 
            background: #000; color: #fff; transition: 0.3s;
        }
        .btn-action:active { transform: scale(0.97); opacity: 0.8; }

        /* –≠–∫—Ä–∞–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ü–ò–ù –∏ OTP) */
        #screen-pin-entry, #screen-otp-entry { 
            background: var(--grad-red); color: white; display:none; 
            flex-direction: column; justify-content: space-between; 
            align-items: center; padding: 100px 30px 60px; 
        }
        .dots-row { display: flex; gap: 15px; margin: 40px 0; }
        .dot { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; transition: 0.2s; }
        .dot.fill { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; max-width: 320px; }
        .n-btn { 
            height: 80px; border-radius: 50%; background: rgba(255,255,255,0.08); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 30px; backdrop-filter: blur(10px); cursor: pointer;
        }
        .n-btn:active { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>

    <div id="screen-auth" class="screen active">
        <div style="padding: 100px 35px; text-align: center; background: #fff; height: 100vh;">
            <h1 style="font-size:56px; font-weight:900; background:linear-gradient(45deg, #ff0000, #ffcc00); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:0; letter-spacing: -2px;">–ö-–û–Ω–ª–∞–π–Ω</h1>
            <p style="color:#999; margin: 15px 0 50px; font-size: 18px;">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–Ω–∫ ‚ùÑÔ∏è</p>
            <input type="number" id="inp-auth-id" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID">
            <button class="btn-action" onclick="logic.startAuth()">–í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç</button>
            <p style="margin-top:40px; color:#888;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞? <span style="color:#007aff; font-weight:600;" onclick="view.nav('screen-reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></p>
        </div>
    </div>

    <div id="screen-reg" class="screen">
        <div style="padding: 60px 25px;">
            <div style="font-size:32px; margin-bottom:25px;" onclick="view.nav('screen-auth')">‚Üê</div>
            <h2 style="font-size:34px; font-weight:900; margin-bottom:30px;">–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h2>
            <input type="number" id="reg-id" placeholder="Telegram ID">
            <input type="text" id="reg-name" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?">
            <input type="password" id="reg-pin" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ü–ò–ù (4 —Ü–∏—Ñ—Ä—ã)" maxlength="4">
            <button class="btn-action" onclick="logic.sendReg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div style="text-align:center;">
            <h2 style="font-size:24px; opacity:0.8;" id="pin-title">–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù</h2>
            <div class="dots-row">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
        </div>
        <div class="numpad">
            <div class="n-btn" onclick="logic.pinTap('1')">1</div><div class="n-btn" onclick="logic.pinTap('2')">2</div><div class="n-btn" onclick="logic.pinTap('3')">3</div>
            <div class="n-btn" onclick="logic.pinTap('4')">4</div><div class="n-btn" onclick="logic.pinTap('5')">5</div><div class="n-btn" onclick="logic.pinTap('6')">6</div>
            <div class="n-btn" onclick="logic.pinTap('7')">7</div><div class="n-btn" onclick="logic.pinTap('8')">8</div><div class="n-btn" onclick="logic.pinTap('9')">9</div>
            <div style="opacity:0"></div><div class="n-btn" onclick="logic.pinTap('0')">0</div><div class="n-btn" onclick="logic.pinTap('DEL')">‚å´</div>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="header-top">
            <div class="user-meta">
                <div>
                    <div id="u-name" style="font-size:28px; font-weight:900;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div id="u-id" style="font-size:13px; opacity:0.5; margin-top:4px;">ID: ---</div>
                </div>
                <div class="header-actions">
                    <div class="h-btn btn-qr" onclick="alert('–°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω')">üì∑</div>
                    <div class="h-btn btn-history" onclick="view.nav('screen-hist')">üìã</div>
                    <div class="ava-box">
                        <span class="santa-hat">üéÖ</span>
                        <span id="u-ava">?</span>
                    </div>
                </div>
            </div>
            <div class="cards-slider" id="u-cards-box">
                </div>
        </div>

        <div class="menu-section">
            <div class="menu-item" onclick="view.nav('screen-send')">
                <div class="m-icon" style="background:#fff0f0; color:#e74c3c;">üéÅ</div>
                <div style="flex:1;"><b>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏</b><div style="font-size:12px; color:#aaa;">–ü–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏</div></div>
            </div>
            <div class="menu-item" onclick="view.nav('screen-ex')">
                <div class="m-icon" style="background:#e3f2fd; color:#3498db;">üíµ</div>
                <div style="flex:1;"><b>–û–±–º–µ–Ω –≤–∞–ª—é—Ç</b><div id="val-usd-rate" style="font-size:12px; color:#aaa;">–ö—É—Ä—Å: 91.20 ‚ÇΩ</div></div>
            </div>
            <div class="menu-item" onclick="view.nav('screen-gold')">
                <div class="m-icon" style="background:#fff9e6; color:#f1c40f;">üåü</div>
                <div style="flex:1;"><b>–ö–∞—Ä—Ç–∞ Gold</b><div style="font-size:12px; color:#aaa;">–õ–∏–º–∏—Ç –¥–æ 500 000 ‚ÇΩ</div></div>
            </div>
        </div>
    </div>

    <div id="screen-hist" class="screen">
        <div style="padding: 65px 25px 20px; background:#fff; border-radius: 0 0 40px 40px; margin-bottom: 20px;">
            <div style="font-size:32px; margin-bottom:15px; cursor:pointer;" onclick="view.nav('screen-main')">‚Üê</div>
            <h2 style="font-size:34px; font-weight:900; margin:0;">–ò—Å—Ç–æ—Ä–∏—è</h2>
        </div>
        <div class="hist-container" id="hist-list-box">
            </div>
    </div>

    <div id="screen-send" class="screen">
        <div class="form-group">
            <div style="font-size:32px; margin-bottom:25px; cursor:pointer;" onclick="view.nav('screen-main')">‚Üê</div>
            <h2 style="font-size:30px; font-weight:800;">–ü–µ—Ä–µ–≤–æ–¥ üéÅ</h2>
            <input type="text" id="send-target" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–ª–∏ –∏–º—è">
            <input type="number" id="send-val" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
            <textarea id="send-msg" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–µ—Ä–µ–≤–æ–¥—É" style="height:120px; padding-top:20px;"></textarea>
            <button class="btn-action" onclick="bank.execTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        </div>
    </div>

    <div id="screen-ex" class="screen">
        <div class="form-group">
            <div style="font-size:32px; margin-bottom:25px; cursor:pointer;" onclick="view.nav('screen-main')">‚Üê</div>
            <h2 style="font-size:30px; font-weight:800;">–ö—É–ø–∏—Ç—å USD üíµ</h2>
            <div style="background:#fff; padding:30px; border-radius:30px; text-align:center; margin-bottom:25px; box-shadow:0 10px 20px rgba(0,0,0,0.03);">
                <div style="font-size:48px; font-weight:900;">91.20 ‚ÇΩ</div>
                <div style="color:#aaa; margin-top:5px;">–¶–µ–Ω–∞ –∑–∞ 1 –¥–æ–ª–ª–∞—Ä</div>
            </div>
            <input type="number" id="ex-val" placeholder="–°–∫–æ–ª—å–∫–æ $ –∫—É–ø–∏—Ç—å?">
            <button class="btn-action" onclick="bank.execExchange()">–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–º–µ–Ω</button>
        </div>
    </div>

    <div id="screen-gold" class="screen">
        <div class="form-group">
            <div style="font-size:32px; margin-bottom:25px; cursor:pointer;" onclick="view.nav('screen-main')">‚Üê</div>
            <h2 style="font-size:30px; font-weight:800;">–ö–∞—Ä—Ç–∞ Gold üåü</h2>
            <p style="color:#777; line-height:1.5; margin-bottom:30px;">–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å –∫—Ä–µ–¥–∏—Ç–Ω—ã–º –ª–∏–º–∏—Ç–æ–º. –ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É, –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ—ë –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.</p>
            <input type="number" id="gold-val" placeholder="–ñ–µ–ª–∞–µ–º—ã–π –ª–∏–º–∏—Ç">
            <button class="btn-action" onclick="bank.reqGold()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç</button>
        </div>
    </div>

    <script>
        // –ö–û–ù–§–ò–ì
        const TG_BOT = '8548215166:AAGVqNJxcZe_2bzWiaJIAFz57WRsIYjZQpM';
        const TG_ADMIN = '7597506775';
        const FB_CONF = { apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", projectId: "webapp-b7149" };
        
        firebase.initializeApp(FB_CONF);
        const rdb = firebase.database();

        let appState = { 
            currentUser: null, 
            clients: [], 
            pinInput: "" 
        };

        // 1. –°–ù–ï–ñ–ò–ù–ö–ò (–ê–Ω–∏–º–∞—Ü–∏—è)
        const cvs = document.getElementById('snow-canvas');
        const ctx = cvs.getContext('2d');
        let flakes = [];
        function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<70; i++) flakes.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, r:Math.random()*2+1, v:Math.random()*1+0.4});
        function loop() {
            ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle="rgba(255,255,255,0.8)"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=f.v; if(f.y>cvs.height) f.y=-10; });
            ctx.fill(); requestAnimationFrame(loop);
        }
        loop();

        // 2. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï (View)
        const view = {
            nav: (screenId) => {
                document.querySelectorAll('.screen').forEach(s => { 
                    s.classList.remove('active'); 
                    setTimeout(() => { if(!s.classList.contains('active')) s.style.display='none' }, 400); 
                });
                const target = document.getElementById(screenId);
                target.style.display = (screenId.includes('entry')) ? 'flex' : 'block';
                setTimeout(() => target.classList.add('active'), 50);
                if(screenId === 'screen-hist') view.renderHistory();
            },
            renderHome: () => {
                const u = appState.currentUser;
                if(!u) return;
                document.getElementById('u-name').innerText = u.name;
                document.getElementById('u-id').innerText = 'ID: ' + u.telegramId;
                document.getElementById('u-ava').innerText = u.name[0].toUpperCase();
                
                let cardsHtml = `<div class="card-item card-main"><div>MIR Physical</div><div style="font-size:28px; font-weight:900;">${(u.balance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                if(u.usd > 0) cardsHtml += `<div class="card-item card-usd"><div>Digital USD</div><div style="font-size:28px; font-weight:900;">${u.usd.toFixed(2)} $</div></div>`;
                if(u.hasGold) cardsHtml += `<div class="card-item card-gold"><div>Gold Credit</div><div style="font-size:28px; font-weight:900;">${(u.creditLimit||0).toLocaleString()} ‚ÇΩ</div></div>`;
                document.getElementById('u-cards-box').innerHTML = cardsHtml;
            },
            renderHistory: () => {
                const box = document.getElementById('hist-list-box');
                rdb.ref(`history/${appState.currentUser.fbKey}`).on('value', snap => {
                    const data = snap.val();
                    if(!data) { box.innerHTML = '<p style="text-align:center; color:#888; padding:40px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>'; return; }
                    box.innerHTML = Object.values(data).reverse().map(h => `
                        <div class="hist-row">
                            <div class="hist-info"><b>${h.title}</b><span>${h.status === 'wait' ? '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' : '–ò—Å–ø–æ–ª–Ω–µ–Ω–æ'}</span></div>
                            <div class="hist-val ${h.type === 'plus' ? 'val-plus' : 'val-minus'}">
                                ${h.type === 'plus' ? '+' : '-'}${h.val.toLocaleString()} ${h.unit || '‚ÇΩ'}
                            </div>
                        </div>
                    `).join('');
                });
            }
        };

        // 3. –õ–û–ì–ò–ö–ê (Logic)
        const logic = {
            init: () => {
                // –°–ª—É—à–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                rdb.ref('clients').on('value', snap => {
                    const data = snap.val();
                    appState.clients = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
                    if(appState.currentUser) {
                        appState.currentUser = appState.clients.find(c => c.fbKey === appState.currentUser.fbKey);
                        view.renderHome();
                    }
                });

                // –û–¥–æ–±—Ä–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ
                const url = new URLSearchParams(window.location.search);
                if(url.get('action') === 'reg_ok') {
                    const newUser = {
                        telegramId: url.get('id'),
                        name: decodeURIComponent(url.get('name')),
                        clientPin: url.get('pin'),
                        balance: 500,
                        usd: 0
                    };
                    rdb.ref('clients').push(newUser).then(() => {
                        alert("–ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
                        window.location.href = window.location.pathname;
                    });
                }
            },
            startAuth: () => {
                const id = document.getElementById('inp-auth-id').value;
                const found = appState.clients.find(c => String(c.telegramId) === String(id));
                if(found) {
                    appState.currentUser = found;
                    appState.pinInput = "";
                    view.nav('screen-pin-entry');
                } else alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.");
            },
            pinTap: (val) => {
                if(val === 'DEL') appState.pinInput = appState.pinInput.slice(0, -1);
                else if(appState.pinInput.length < 4) appState.pinInput += val;

                document.querySelectorAll('.dot').forEach((d, i) => {
                    d.classList.toggle('fill', i < appState.pinInput.length);
                });

                if(appState.pinInput.length === 4) {
                    if(appState.pinInput === String(appState.currentUser.clientPin)) {
                        view.renderHome(); // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        view.nav('screen-main'); // –ü–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º
                    } else {
                        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥");
                        appState.pinInput = "";
                        document.querySelectorAll('.dot').forEach(d => d.classList.remove('fill'));
                    }
                }
            },
            sendReg: () => {
                const id = document.getElementById('reg-id').value;
                const name = document.getElementById('reg-name').value;
                const pin = document.getElementById('reg-pin').value;
                const approveLink = `${window.location.href}?action=reg_ok&id=${id}&name=${encodeURIComponent(name)}&pin=${pin}`;

                fetch(`https://api.telegram.org/bot${TG_BOT}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: TG_ADMIN,
                        text: `üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!\n–ò–º—è: ${name}\nID: ${id}\n–ü–ò–ù: ${pin}`,
                        reply_markup: { inline_keyboard: [[{ text: "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", url: approveLink }]] }
                    })
                });
                alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω—É. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.");
                view.nav('screen-auth');
            }
        };

        // 4. –ë–ê–ù–ö–û–í–°–ö–ò–ï –û–ü–ï–†–ê–¶–ò–ò
        const bank = {
            execTransfer: () => {
                const target = document.getElementById('send-target').value;
                const val = parseInt(document.getElementById('send-val').value);
                const u = appState.currentUser;
                if(u.balance < val) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                rdb.ref(`history/${u.fbKey}`).push({ title: '–ü–µ—Ä–µ–≤–æ–¥: ' + target, val: val, type: 'minus', status: 'wait' });
                fetch(`https://api.telegram.org/bot${TG_BOT}/sendMessage?chat_id=${TG_ADMIN}&text=üí∏ –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥!\n–û—Ç: ${u.name}\n–ö–æ–º—É: ${target}\n–°—É–º–º–∞: ${val}‚ÇΩ`);
                
                alert("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω—É.");
                view.nav('screen-main');
            },
            execExchange: () => {
                const amt = parseFloat(document.getElementById('ex-val').value);
                const cost = Math.round(amt * 91.2);
                const u = appState.currentUser;

                if(u.balance < cost) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä—É–±–ª–µ–π –¥–ª—è –æ–±–º–µ–Ω–∞");

                rdb.ref(`clients/${u.fbKey}`).update({
                    balance: u.balance - cost,
                    usd: (u.usd || 0) + amt
                });
                rdb.ref(`history/${u.fbKey}`).push({ title: '–û–±–º–µ–Ω –Ω–∞ USD', val: amt, unit: '$', type: 'plus', status: 'done' });
                
                alert("–û–±–º–µ–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω!");
                view.nav('screen-main');
            },
            reqGold: () => {
                const val = document.getElementById('gold-val').value;
                fetch(`https://api.telegram.org/bot${TG_BOT}/sendMessage?chat_id=${TG_ADMIN}&text=üåü –ó–∞—è–≤–∫–∞ –Ω–∞ GOLD –∫–∞—Ä—Ç—É!\n–ö–ª–∏–µ–Ω—Ç: ${appState.currentUser.name}\n–õ–∏–º–∏—Ç: ${val}‚ÇΩ`);
                alert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞.");
                view.nav('screen-main');
            }
        };

        window.onload = logic.init;
    </script>
</body>
</html>
