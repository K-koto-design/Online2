<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö-–û–Ω–ª–∞–π–Ω PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --bg: #f0f4f8;
            --grad-dark: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --grad-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --radius-xl: 32px;
            --radius-m: 18px;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, sans-serif; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        #snow-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }

        /* Screens */
        .screen { display: none; position: absolute; inset: 0; background: var(--bg); z-index: 10; opacity: 0; transform: translateY(20px); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen.active { display: block !important; opacity: 1; transform: translateY(0); }

        /* Auth/OTP/PIN */
        .auth-container { height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 80px 30px 50px; background: var(--grad-dark); color: white; text-align: center; }
        .otp-display { display: flex; gap: 10px; margin: 30px 0; }
        .otp-dot { width: 45px; height: 55px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
        .otp-dot.active { border-color: #00f2fe; box-shadow: 0 0 10px #00f2fe; }
        
        .pin-dots { display: flex; gap: 15px; margin: 30px 0; }
        .p-dot { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; }
        .p-dot.active { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 300px; }
        .k-btn { height: 75px; border-radius: 50%; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(10px); }

        /* Main Header */
        .header { background: var(--grad-dark); padding: 70px 25px 40px; border-radius: 0 0 45px 45px; color: white; position: relative; }
        .user-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .actions { display: flex; gap: 12px; }
        .circle-btn { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
        .btn-qr { background: var(--grad-accent); border: none; }

        /* Cards */
        .card-scroll { display: flex; overflow-x: auto; padding: 10px 0 20px; gap: 15px; scrollbar-width: none; }
        .card-scroll::-webkit-scrollbar { display: none; }
        .bank-card { min-width: 240px; height: 140px; border-radius: 28px; padding: 25px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .card-black { background: linear-gradient(160deg, #1a1a1a, #000); color: white; }
        .card-blue { background: linear-gradient(160deg, #004fac, #001a33); color: white; }

        /* History */
        .hist-list { padding: 20px 25px; }
        .h-card { background: white; padding: 18px; border-radius: 22px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .h-info b { display: block; font-size: 16px; }
        .h-info span { font-size: 12px; color: #999; }
        .h-amt { font-weight: 800; font-size: 17px; }
        .amt-pos { color: #27ae60; }
        .amt-neg { color: #000; }

        /* Scanner */
        #qr-video-container { position: fixed; inset: 0; background: black; z-index: 10000; display: none; }
        .scan-overlay { position: absolute; inset: 0; border: 50px solid rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .scan-box { width: 250px; height: 250px; border: 3px solid #00f2fe; border-radius: 20px; box-shadow: 0 0 20px #00f2fe; }

        input { width: 100%; height: 65px; border-radius: 20px; border: 1px solid #eee; padding: 0 20px; font-size: 17px; margin-bottom: 15px; background: #f9f9f9; }
        .btn-pay { width: 100%; height: 65px; border-radius: 22px; border: none; background: #000; color: #fff; font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>

    <div id="qr-video-container">
        <div id="reader" style="width: 100%; height: 100%;"></div>
        <div class="scan-overlay"><div class="scan-box"></div></div>
        <button onclick="bank.stopScanner()" style="position:fixed; bottom:50px; left:50%; transform:translateX(-50%); padding:15px 40px; border-radius:20px; z-index:10001;">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-container" style="background: #fff; color: #000;">
            <div style="margin-top: 50px;">
                <h1 style="font-size: 48px; font-weight: 900; background: var(--grad-dark); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">–ö-–û–Ω–ª–∞–π–Ω</h1>
                <p style="color: #888;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞</p>
                <input type="number" id="auth-id-input" placeholder="7597506775">
                <button class="btn-pay" onclick="logic.sendOTP()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –≤ Telegram</button>
            </div>
            <p onclick="view.nav('screen-reg')" style="color: #007aff; margin-bottom: 20px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
        </div>
    </div>

    <div id="screen-otp" class="screen">
        <div class="auth-container">
            <div>
                <h2>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h2>
                <p style="opacity: 0.6;">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –≤ TG</p>
                <div class="otp-display" id="otp-dots-wrap">
                    <div class="otp-dot" id="ot-0"></div><div class="otp-dot" id="ot-1"></div><div class="otp-dot" id="ot-2"></div>
                    <div class="otp-dot" id="ot-3"></div><div class="otp-dot" id="ot-4"></div><div class="otp-dot" id="ot-5"></div>
                </div>
            </div>
            <div class="keypad">
                <div class="k-btn" onclick="logic.tapOtp('1')">1</div><div class="k-btn" onclick="logic.tapOtp('2')">2</div><div class="k-btn" onclick="logic.tapOtp('3')">3</div>
                <div class="k-btn" onclick="logic.tapOtp('4')">4</div><div class="k-btn" onclick="logic.tapOtp('5')">5</div><div class="k-btn" onclick="logic.tapOtp('6')">6</div>
                <div class="k-btn" onclick="logic.tapOtp('7')">7</div><div class="k-btn" onclick="logic.tapOtp('8')">8</div><div class="k-btn" onclick="logic.tapOtp('9')">9</div>
                <div class="k-btn" onclick="view.nav('screen-auth')">‚Üê</div><div class="k-btn" onclick="logic.tapOtp('0')">0</div><div class="k-btn" onclick="logic.tapOtp('DEL')">‚å´</div>
            </div>
        </div>
    </div>

    <div id="screen-pin" class="screen">
        <div class="auth-container">
            <div>
                <h2 id="welcome-name">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º</h2>
                <p style="opacity: 0.6;">–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –ü–ò–ù</p>
                <div class="pin-dots">
                    <div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div>
                </div>
            </div>
            <div class="keypad">
                <div class="k-btn" onclick="logic.tapPin('1')">1</div><div class="k-btn" onclick="logic.tapPin('2')">2</div><div class="k-btn" onclick="logic.tapPin('3')">3</div>
                <div class="k-btn" onclick="logic.tapPin('4')">4</div><div class="k-btn" onclick="logic.tapPin('5')">5</div><div class="k-btn" onclick="logic.tapPin('6')">6</div>
                <div class="k-btn" onclick="logic.tapPin('7')">7</div><div class="k-btn" onclick="logic.tapPin('8')">8</div><div class="k-btn" onclick="logic.tapPin('9')">9</div>
                <div style="opacity:0"></div><div class="k-btn" onclick="logic.tapPin('0')">0</div><div class="k-btn" onclick="logic.tapPin('DEL')">‚å´</div>
            </div>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="header">
            <div class="user-row">
                <div>
                    <div id="h-name" style="font-size: 26px; font-weight: 900;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div id="h-id" style="font-size: 13px; opacity: 0.5;">ID: ---</div>
                </div>
                <div class="actions">
                    <div class="circle-btn btn-qr" onclick="bank.startScanner()">üì∑</div>
                    <div class="circle-btn" onclick="view.nav('screen-history')">üìã</div>
                    <div style="position:relative; width:55px; height:55px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px;">
                        <span style="position:absolute; top:-15px; left:-10px; font-size:28px;">üéÖ</span>
                        <span id="h-ava">?</span>
                    </div>
                </div>
            </div>
            <div class="card-scroll" id="h-cards"></div>
        </div>
        <div style="padding: 20px 25px;">
            <div style="background:white; padding:20px; border-radius:24px; display:flex; gap:15px; align-items:center;" onclick="view.nav('screen-transfer')">
                <div style="width:50px; height:50px; background:#fff0f0; border-radius:15px; display:flex; align-items:center; justify-content:center; font-size:24px;">üéÅ</div>
                <div><b>–ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥</b><div style="font-size:12px; color:#aaa;">–ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–æ ID</div></div>
            </div>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div style="padding: 60px 25px 20px;">
            <div style="font-size: 32px;" onclick="view.nav('screen-main')">‚Üê</div>
            <h1 style="font-size: 32px; font-weight: 900; margin-top: 10px;">–ò—Å—Ç–æ—Ä–∏—è</h1>
        </div>
        <div class="hist-list" id="hist-list-wrap"></div>
    </div>

    <script>
        const TG_TOKEN = '8548215166:AAGVqNJxcZe_2bzWiaJIAFz57WRsIYjZQpM';
        const TG_ADMIN = '7597506775';
        const config = { apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", projectId: "webapp-b7149" };
        
        firebase.initializeApp(config);
        const rdb = firebase.database();

        let state = { user: null, clients: [], otp: "", pin: "", currentOtp: "", qrScanner: null };

        // Snow
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<60; i++) flakes.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*2+1, v: Math.random()*1+0.4});
        function snow() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=f.v; if(f.y>canvas.height) f.y=-10; });
            ctx.fill(); requestAnimationFrame(snow);
        }
        snow();

        const view = {
            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const t = document.getElementById(id);
                t.style.display = (id.includes('otp') || id.includes('pin')) ? 'flex' : 'block';
                setTimeout(() => t.classList.add('active'), 50);
                if(id === 'screen-history') view.loadHistory();
            },
            updateHome: () => {
                const u = state.user;
                document.getElementById('h-name').innerText = u.name;
                document.getElementById('h-id').innerText = 'ID: ' + u.telegramId;
                document.getElementById('h-ava').innerText = u.name[0].toUpperCase();
                
                let cards = `<div class="bank-card card-black"><div>MIR Physical</div><div style="font-size:26px; font-weight:900;">${(u.balance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                if(u.usd > 0) cards += `<div class="bank-card card-blue"><div>Digital USD</div><div style="font-size:26px; font-weight:900;">${u.usd.toFixed(2)} $</div></div>`;
                document.getElementById('h-cards').innerHTML = cards;
            },
            loadHistory: () => {
                const wrap = document.getElementById('hist-list-wrap');
                rdb.ref(`history/${state.user.fbKey}`).on('value', snap => {
                    const data = snap.val();
                    if(!data) { wrap.innerHTML = '<p style="text-align:center; color:#999;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>'; return; }
                    wrap.innerHTML = Object.values(data).reverse().map(h => `
                        <div class="h-card">
                            <div class="h-info"><b>${h.title}</b><span>${h.status === 'wait' ? '–û–∂–∏–¥–∞–Ω–∏–µ' : '–£—Å–ø–µ—à–Ω–æ'}</span></div>
                            <div class="h-amt ${h.type==='plus'?'amt-pos':'amt-neg'}">${h.type==='plus'?'+':'-'}${h.val.toLocaleString()} ‚ÇΩ</div>
                        </div>
                    `).join('');
                });
            }
        };

        const logic = {
            init: () => {
                rdb.ref('clients').on('value', snap => {
                    const d = snap.val();
                    state.clients = d ? Object.keys(d).map(k => ({...d[k], fbKey: k})) : [];
                    if(state.user) state.user = state.clients.find(c => c.fbKey === state.user.fbKey);
                });
            },
            sendOTP: () => {
                const id = document.getElementById('auth-id-input').value;
                const found = state.clients.find(c => String(c.telegramId) === String(id));
                if(!found) return alert("ID –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
                
                state.user = found;
                state.currentOtp = Math.floor(100000 + Math.random() * 900000).toString();
                
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: id, text: `‚ùÑÔ∏è –í–∞—à –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥: ${state.currentOtp}` })
                });
                
                state.otp = ""; logic.renderOtp();
                view.nav('screen-otp');
            },
            tapOtp: (v) => {
                if(v === 'DEL') state.otp = state.otp.slice(0, -1);
                else if(state.otp.length < 6) state.otp += v;
                logic.renderOtp();
                if(state.otp === state.currentOtp) {
                    state.pin = ""; logic.renderPin();
                    view.nav('screen-pin');
                }
            },
            tapPin: (v) => {
                if(v === 'DEL') state.pin = state.pin.slice(0, -1);
                else if(state.pin.length < 4) state.pin += v;
                logic.renderPin();
                if(state.pin.length === 4) {
                    if(state.pin === String(state.user.clientPin)) {
                        view.updateHome();
                        view.nav('screen-main');
                    } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù"); state.pin = ""; logic.renderPin(); }
                }
            },
            renderOtp: () => {
                for(let i=0; i<6; i++) {
                    const d = document.getElementById(`ot-${i}`);
                    d.innerText = state.otp[i] || "";
                    d.classList.toggle('active', i === state.otp.length);
                }
            },
            renderPin: () => {
                document.querySelectorAll('.p-dot').forEach((d, i) => d.classList.toggle('active', i < state.pin.length));
            }
        };

        const bank = {
            startScanner: () => {
                document.getElementById('qr-video-container').style.display = 'block';
                state.qrScanner = new Html5Qrcode("reader");
                state.qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                    if(text.includes('pay:')) {
                        bank.stopScanner();
                        const val = text.split(':')[1];
                        alert("–û–ø–ª–∞—Ç–∞ –ø–æ QR: " + val + "‚ÇΩ");
                        // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è
                    }
                });
            },
            stopScanner: () => {
                if(state.qrScanner) {
                    state.qrScanner.stop().then(() => {
                        document.getElementById('qr-video-container').style.display = 'none';
                    });
                }
            }
        };

        window.onload = logic.init;
    </script>
</body>
</html>
