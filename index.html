<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–Ω–ª–∞–π–Ω</title>
    <meta name="apple-mobile-web-app-title" content="–ö-–û–Ω–ª–∞–π–Ω">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --bg-body: #f0f4f8;
            --grad-red: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --grad-pay: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --white: #ffffff;
            --danger: #ff3b30;
            --radius-card: 28px;
            --radius-btn: 22px;
            --anim-screen: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-body); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; -webkit-font-smoothing: antialiased; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .screen { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; overflow-y: auto; background: var(--bg-body); z-index: 10; opacity: 0; transform: scale(0.96); transition: opacity var(--anim-screen), transform var(--anim-screen); }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }
        .auth-wrap { padding: 80px 30px; text-align: center; min-height: 100vh; background: #fff; }
        .logo-text { font-size: 52px; font-weight: 900; background: linear-gradient(45deg, #ff0000, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; letter-spacing: -2px; }
        #screen-pin-entry, #screen-otp-entry { background: var(--grad-red); color: white; display:none; flex-direction: column; justify-content: space-between; align-items: center; padding: 80px 30px 50px; }
        .pin-dots { display: flex; gap: 15px; margin: 40px 0; }
        .p-dot { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; }
        .p-dot.active { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }
        .otp-input-group { display: flex; gap: 8px; justify-content: center; margin-top: 30px; }
        .otp-box { width: 45px; height: 55px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; }
        .otp-box.active { border-color: #ffcc00; box-shadow: 0 0 10px rgba(255,204,0,0.3); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 300px; margin-top: 20px; }
        .k-btn { height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(5px); cursor: pointer; }
        .k-btn:active { background: rgba(255,255,255,0.3); }
        .header-top { background: var(--grad-red); padding: 60px 0 40px; border-radius: 0 0 50px 50px; color: white; position: relative; }
        .user-meta { display: flex; justify-content: space-between; padding: 0 30px; align-items: center; margin-bottom: 25px; }
        .ava-box { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; border: 2px solid rgba(255,255,255,0.3); position: relative; }
        .santa-hat { position: absolute; top: -20px; left: -10px; font-size: 30px; transform: rotate(-15deg); }
        .scan-trigger { width: 45px; height: 45px; background: var(--grad-pay); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-left: 15px; box-shadow: 0 4px 15px rgba(0, 242, 254, 0.4); }
        .cards-row { display: flex; overflow-x: auto; padding: 10px 30px 30px; gap: 15px; scrollbar-width: none; }
        .v-card { min-width: 190px; height: 240px; border-radius: var(--radius-card); padding: 25px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 15px 30px rgba(0,0,0,0.3); flex-shrink: 0; }
        .c-black { background: linear-gradient(160deg, #1a1a1a 0%, #000 100%); color: white; }
        .c-blue { background: linear-gradient(160deg, #002f6c 0%, #001433 100%); color: white; }
        .c-gold { background: linear-gradient(160deg, #d4af37 0%, #f1c40f 100%); color: #4a3b00; }
        .widget { background: #fff; border-radius: 24px; padding: 20px; margin: 15px 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer;}
        .w-ico { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .history-box { padding: 20px 25px; }
        .h-item { background: #fff; border-radius: 18px; padding: 15px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .h-ico { font-size: 22px; width: 45px; height: 45px; background: #f8f9fa; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .h-info { flex: 1; }
        .h-name { font-size: 15px; font-weight: 700; color: #333; }
        .h-status { font-size: 12px; margin-top: 2px; }
        .h-sum { font-weight: 800; font-size: 16px; }
        .sum-neg { color: #000; }
        .sum-pos { color: #27ae60; }
        .sum-wait { color: #f39c12; }
        input, textarea { width: 100%; height: 60px; border-radius: 18px; border: 1px solid #eee; padding: 0 20px; font-size: 17px; margin-bottom: 15px; background: #f9f9f9; font-family: inherit; outline: none; }
        .btn-main { width: 100%; height: 60px; border: none; border-radius: var(--radius-btn); font-size: 17px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-black { background: #000; color: #fff; }
        .btn-red { background: var(--danger); color: #fff; }
        .btn-pay { background: var(--grad-pay); color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-in { background: #fff; width: 85%; border-radius: 35px; padding: 35px; text-align: center; }
        .modal-pay { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.3); color: white; }
        .form-box { padding: 60px 25px; }
        .history-trigger { position: absolute; top: 60px; right: 25px; font-size: 30px; cursor: pointer; z-index: 100; transition: transform 0.2s; }
        #qr-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; }
        #reader { width: 100%; height: 100%; }
        .qr-overlay { position: absolute; inset: 0; border: 40px solid rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .qr-cutout { width: 250px; height: 250px; border: 4px solid #00f2fe; border-radius: 20px; }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>

    <div id="qr-screen">
        <div id="reader"></div>
        <div class="qr-overlay"><div class="qr-cutout"></div></div>
        <button onclick="bank.closeScanner()" style="position:fixed; bottom:50px; left:50%; transform:translateX(-50%); padding:15px 40px; border-radius:20px; background:white; border:none; font-weight:800; z-index:10001;">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="modal-qr-pay" class="modal">
        <div class="modal-in modal-pay">
            <div style="font-size:50px; margin-bottom:10px;">üí≥</div>
            <h2 style="margin:0">–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
            <div id="qr-pay-sum" style="font-size:48px; font-weight:900; margin:15px 0;">0 ‚ÇΩ</div>
            <p style="opacity:0.8; margin-bottom:25px;">–°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç —Å–ø–∏—Å–∞–Ω—ã —Å –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ MIR</p>
            <button class="btn-main btn-pay" id="confirm-qr-btn">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –û–ü–õ–ê–¢–£</button>
            <div onclick="document.getElementById('modal-qr-pay').style.display='none'" style="margin-top:20px; opacity:0.6; cursor:pointer;">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

    <div id="modal-success" class="modal">
        <div class="modal-in">
            <div style="font-size:60px; margin-bottom:15px;">üéÑ</div>
            <h2 id="suc-h">–ì–æ—Ç–æ–≤–æ!</h2>
            <div id="suc-val" style="font-size:32px; font-weight:900; margin:10px 0;">0 ‚ÇΩ</div>
            <p id="suc-p" style="color:#888; margin-bottom:25px;"></p>
            <button class="btn-main btn-red" onclick="view.hideSuccess()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-wrap">
            <h1 class="logo-text">–ö-–û–Ω–ª–∞–π–Ω</h1>
            <p style="color:#888; font-weight:500; margin: 10px 0 40px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID ‚ùÑÔ∏è</p>
            <input type="number" id="auth-tg-id" placeholder="ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1234567)">
            <button class="btn-main btn-black" onclick="logic.requestOTP()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –≤ Telegram</button>
            <p style="margin-top:25px; color:#666;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="color:#007aff; cursor:pointer; font-weight:600;" onclick="view.nav('screen-register')">–°–æ–∑–¥–∞—Ç—å</span></p>
        </div>
    </div>

    <div id="screen-register" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-auth')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</h2>
            <p style="color:#888; margin-bottom:25px;">–ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</p>
            <input type="number" id="reg-tg-id" placeholder="–í–∞—à Telegram ID">
            <input type="text" id="reg-name" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="password" id="reg-pin" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ü–ò–ù (4 —Ü–∏—Ñ—Ä—ã)" maxlength="4" inputmode="numeric">
            <button class="btn-main btn-black" onclick="logic.registerRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>

    <div id="screen-otp-entry" class="screen">
        <div style="text-align:center;">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <p style="opacity:0.7;">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –≤ –≤–∞—à Telegram –±–æ—Ç</p>
            <div class="otp-input-group">
                <div class="otp-box" id="otp-0"></div><div class="otp-box" id="otp-1"></div><div class="otp-box" id="otp-2"></div>
                <div class="otp-box" id="otp-3"></div><div class="otp-box" id="otp-4"></div><div class="otp-box" id="otp-5"></div>
            </div>
        </div>
        <div class="keypad">
            <div class="k-btn" onclick="logic.tapOtp('1')">1</div><div class="k-btn" onclick="logic.tapOtp('2')">2</div><div class="k-btn" onclick="logic.tapOtp('3')">3</div>
            <div class="k-btn" onclick="logic.tapOtp('4')">4</div><div class="k-btn" onclick="logic.tapOtp('5')">5</div><div class="k-btn" onclick="logic.tapOtp('6')">6</div>
            <div class="k-btn" onclick="logic.tapOtp('7')">7</div><div class="k-btn" onclick="logic.tapOtp('8')">8</div><div class="k-btn" onclick="logic.tapOtp('9')">9</div>
            <div class="k-btn" style="opacity:0;"></div><div class="k-btn" onclick="logic.tapOtp('0')">0</div><div class="k-btn" onclick="logic.tapOtp('DEL')">‚å´</div>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div style="text-align:center;">
            <h2 id="pin-user-name">–í—Ö–æ–¥</h2>
            <div class="pin-dots">
                <div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div>
            </div>
        </div>
        <div class="keypad">
            <div class="k-btn" onclick="logic.tapPin('1')">1</div><div class="k-btn" onclick="logic.tapPin('2')">2</div><div class="k-btn" onclick="logic.tapPin('3')">3</div>
            <div class="k-btn" onclick="logic.tapPin('4')">4</div><div class="k-btn" onclick="logic.tapPin('5')">5</div><div class="k-btn" onclick="logic.tapPin('6')">6</div>
            <div class="k-btn" onclick="logic.tapPin('7')">7</div><div class="k-btn" onclick="logic.tapPin('8')">8</div><div class="k-btn" onclick="logic.tapPin('9')">9</div>
            <div class="k-btn" style="opacity:0;"></div><div class="k-btn" onclick="logic.tapPin('0')">0</div><div class="k-btn" onclick="logic.tapPin('DEL')">‚å´</div>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="history-trigger" onclick="view.nav('screen-history')">üìÉ</div>
        <div class="header-top">
            <div class="user-meta">
                <div style="display:flex; align-items:center;">
                    <div>
                        <div id="h-name" style="font-size:24px; font-weight:900;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div id="h-tg" style="font-size:12px; opacity:0.6;">ID: ---</div>
                    </div>
                    <div class="scan-trigger" onclick="bank.openScanner()">üì∑</div>
                </div>
                <div class="ava-box"><span class="santa-hat">üéÖ</span><span id="h-ava">?</span></div>
            </div>
            <div class="cards-row" id="h-cards"></div>
        </div>
        <div class="widget" onclick="view.nav('screen-transfer')">
            <div class="w-ico" style="background:#fff0f0; color:#e74c3c;">üéÅ</div>
            <div style="flex:1;"><b>–ü–µ—Ä–µ–≤–æ–¥</b><div style="font-size:12px; color:#aaa;">–ü–æ –∏–º–µ–Ω–∏ –∏–ª–∏ Telegram ID</div></div>
        </div>
        <div class="widget" onclick="view.nav('screen-exchange')">
            <div class="w-ico" style="background:#e3f2fd; color:#3498db;">üíµ</div>
            <div style="flex:1;"><b>–û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã</b><div id="w-usd">0.00 $</div></div>
        </div>
        <div class="widget" onclick="view.nav('screen-loan')">
            <div class="w-ico" style="background:#fff9e6; color:#f1c40f;">üåü</div>
            <div style="flex:1;"><b>–ö–∞—Ä—Ç–∞ Gold</b><div style="font-size:12px; color:#aaa;">–õ–∏–º–∏—Ç –¥–æ 500–∫</div></div>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div class="form-box" style="padding-top: 60px;">
            <div style="font-size:30px; margin-bottom:10px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900; margin-bottom:20px;">–ò—Å—Ç–æ—Ä–∏—è</h2>
            <div class="history-box" id="full-history-list"></div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–ü–µ—Ä–µ–≤–æ–¥ üéÑ</h2>
            <input type="text" id="tr-target" placeholder="ID –∏–ª–∏ –ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
            <input type="number" id="tr-val" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
            <textarea id="tr-msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            <button class="btn-main btn-black" onclick="bank.send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="screen-exchange" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–û–±–º–µ–Ω ‚ùÑÔ∏è</h2>
            <div style="text-align:center; padding:30px; background:#fff; border-radius:30px; box-shadow:0 10px 20px rgba(0,0,0,0.05);">
                <div style="font-size:42px; font-weight:900;">91.20 ‚ÇΩ</div>
                <p style="color:#aaa; margin-bottom:20px;">–ö—É—Ä—Å –∑–∞ 1 $</p>
                <input type="number" id="ex-val" placeholder="–°–∫–æ–ª—å–∫–æ $ –∫—É–ø–∏—Ç—å?">
                <button class="btn-main btn-black" onclick="bank.exchange()">–ö—É–ø–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-loan" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–ö–∞—Ä—Ç–∞ Gold üåü</h2>
            <p style="color:#666; margin-bottom:20px;">–ó–∞–ø—Ä–æ—Å–∏—Ç–µ –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫.</p>
            <input type="number" id="ln-val" placeholder="–ñ–µ–ª–∞–µ–º–∞—è —Å—É–º–º–∞">
            <button class="btn-main btn-black" onclick="bank.loan()">–ü–æ–ª—É—á–∏—Ç—å Gold</button>
        </div>
    </div>

    <script>
        const TG_TOKEN = '8548215166:AAGVqNJxcZe_2bzWiaJIAFz57WRsIYjZQpM'; 
        const TG_ADMIN_ID = '7597506775';
        const config = { apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", projectId: "webapp-b7149" };
        firebase.initializeApp(config);
        const rtdb = firebase.database();

        let state = { all: [], user: null, pin: "", otp: "", generatedOtp: "" };
        let scanner = null;

        // Snow effect
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<70; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*2+1, v: Math.random()*1+0.3 });
        function drawSnow() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); }); ctx.fill();
            flakes.forEach(f => { f.y += f.v; if(f.y > canvas.height) f.y = -5; }); requestAnimationFrame(drawSnow);
        }
        drawSnow();

        const view = {
            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); setTimeout(() => { if(!s.classList.contains('active')) s.style.display='none'; }, 400); });
                const t = document.getElementById(id);
                t.style.display = (id === 'screen-pin-entry' || id === 'screen-otp-entry') ? 'flex' : 'block';
                setTimeout(() => t.classList.add('active'), 50);
                if(id === 'screen-history') view.loadHistory();
            },
            drawDash: () => {
                if(!state.user) return;
                const u = state.user;
                document.getElementById('h-name').innerText = u.name;
                document.getElementById('h-tg').innerText = 'ID: ' + u.telegramId;
                document.getElementById('h-ava').innerText = u.name[0];
                document.getElementById('w-usd').innerText = (u.usd || 0).toFixed(2) + " $";
                let cards = `<div class="v-card c-black"><div>MIR Physical</div><div style="font-size:24px; font-weight:800;">${(u.balance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                if(u.usd > 0) cards += `<div class="v-card c-blue"><div>VISA Digital</div><div style="font-size:24px; font-weight:800;">${u.usd.toFixed(2)} $</div></div>`;
                if(u.hasCredit) cards += `<div class="v-card c-gold"><div>GOLD Credit</div><div style="font-size:24px; font-weight:800;">${(u.creditBalance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                document.getElementById('h-cards').innerHTML = cards;
            },
            loadHistory: () => {
                const list = document.getElementById('full-history-list');
                rtdb.ref(`history/${state.user.fbKey}`).on('value', s => {
                    let h = ''; const data = s.val();
                    if(!data) { list.innerHTML = '<p style="color:#aaa; text-align:center;">–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</p>'; return; }
                    Object.keys(data).reverse().forEach(k => {
                        const i = data[k]; const isPlus = i.type === 'plus';
                        const cls = isPlus ? 'sum-pos' : (i.status === 'wait' ? 'sum-wait' : 'sum-neg');
                        h += `<div class="h-item"><div class="h-ico">${i.ico || 'üí≥'}</div><div class="h-info"><div class="h-name">${i.title}</div><div class="h-status">${i.status === 'wait' ? '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ ‚è≥' : (i.status === 'rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ ‚ùå' : '–í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ')}</div></div><div class="h-sum ${cls}">${isPlus?'+':'-'}${i.val.toLocaleString()} ${i.unit || '‚ÇΩ'}</div></div>`;
                    });
                    list.innerHTML = h;
                });
            },
            showSuccess: (h, v, p) => {
                document.getElementById('suc-h').innerText = h; document.getElementById('suc-val').innerText = v; document.getElementById('suc-p').innerText = p;
                document.getElementById('modal-success').style.display = 'flex';
            },
            hideSuccess: () => { document.getElementById('modal-success').style.display='none'; view.nav('screen-home'); }
        };

        const logic = {
            init: () => {
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                rtdb.ref('clients').on('value', s => {
                    const d = s.val(); state.all = d ? Object.keys(d).map(k=>({...d[k], fbKey:k})) : [];
                    if(state.user) { state.user = state.all.find(x=>x.fbKey === state.user.fbKey); view.drawDash(); }
                });

                if(action && !window.modDone) {
                    window.modDone = true;
                    const from = urlParams.get('from'), val = parseInt(urlParams.get('val')), hid = urlParams.get('hid');
                    
                    if(action === 'approve') {
                        const to = urlParams.get('to');
                        const sender = state.all.find(x => x.fbKey === from);
                        const target = state.all.find(x => x.fbKey === to);
                        if(sender && target && sender.balance >= val) {
                            rtdb.ref(`clients/${from}`).update({ balance: sender.balance - val });
                            rtdb.ref(`clients/${to}`).update({ balance: (target.balance||0) + val });
                            rtdb.ref(`history/${from}/${hid}`).update({ status: 'done', ico: 'üéÅ' });
                            rtdb.ref(`history/${to}`).push({ title: '–í—Ö–æ–¥—è—â–∏–π –ø–µ—Ä–µ–≤–æ–¥', val: val, type: 'plus', ico: 'üí∞', status: 'done' });
                            alert("–ü–µ—Ä–µ–≤–æ–¥ –æ–¥–æ–±—Ä–µ–Ω!");
                        }
                    } else if(action === 'reg_approve') {
                        rtdb.ref('clients').push({ telegramId: urlParams.get('id'), name: urlParams.get('name'), clientPin: urlParams.get('pin'), balance: 500, usd: 0 });
                        alert("–ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!");
                    } else if(action === 'loan_approve') {
                        rtdb.ref(`clients/${from}`).update({ hasCredit: true, creditLimit: val, creditBalance: val });
                        rtdb.ref(`history/${from}/${hid}`).update({ status: 'done', ico: 'üåü' });
                        alert("–ö—Ä–µ–¥–∏—Ç –æ–¥–æ–±—Ä–µ–Ω!");
                    } else if(action === 'decline') {
                        rtdb.ref(`history/${from}/${hid}`).update({ status: 'rejected' });
                        alert("–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞");
                    }
                    window.history.replaceState({}, '', window.location.pathname);
                }
            },
            registerRequest: () => {
                const id = document.getElementById('reg-tg-id').value, name = document.getElementById('reg-name').value, pin = document.getElementById('reg-pin').value;
                if(!id || !name || pin.length !== 4) return alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö");
                const kb = { inline_keyboard: [[{ text: "‚úÖ –°–æ–∑–¥–∞—Ç—å", url: `${window.location.href}?action=reg_approve&id=${id}&name=${encodeURIComponent(name)}&pin=${pin}` }, { text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", url: `${window.location.href}?action=decline` }]]};
                logic.sendTg(`üÜï <b>–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</b>\nID: ${id}\n–ò–º—è: ${name}`, kb);
                alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!"); view.nav('screen-auth');
            },
            requestOTP: () => {
                const id = document.getElementById('auth-tg-id').value;
                const found = state.all.find(u => String(u.telegramId) === String(id));
                if(found) {
                    state.user = found; state.generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                    state.otp = ""; logic.updOtpUI();
                    logic.sendTgToUser(found.telegramId, `‚ùÑÔ∏è –ö–æ–¥ –≤—Ö–æ–¥–∞: <b>${state.generatedOtp}</b>`);
                    view.nav('screen-otp-entry');
                } else alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω");
            },
            tapOtp: (v) => {
                if(v === 'DEL') state.otp = state.otp.slice(0, -1); else if(state.otp.length < 6) state.otp += v;
                logic.updOtpUI();
                if(state.otp.length === 6) {
                    if(state.otp === state.generatedOtp) { state.pin = ""; document.getElementById('pin-user-name').innerText = state.user.name; logic.updPinUI(); view.nav('screen-pin-entry'); }
                    else { alert("–ù–µ–≤–µ—Ä–Ω–æ!"); state.otp = ""; logic.updOtpUI(); }
                }
            },
            tapPin: (v) => {
                if(v==='DEL') state.pin = state.pin.slice(0,-1); else if(state.pin.length < 4) state.pin += v;
                logic.updPinUI();
                if(state.pin.length === 4) {
                    if(String(state.user.clientPin) === state.pin) { view.drawDash(); view.nav('screen-home'); }
                    else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù"); state.pin = ""; logic.updPinUI(); }
                }
            },
            updPinUI: () => document.querySelectorAll('.p-dot').forEach((d,i)=>d.classList.toggle('active', i<state.pin.length)),
            updOtpUI: () => { for(let i=0; i<6; i++) { const box = document.getElementById(`otp-${i}`); box.innerText = state.otp[i] || ""; box.classList.toggle('active', i === state.otp.length); } },
            sendTg: (m, kb = null) => {
                const body = { chat_id: TG_ADMIN_ID, text: m, parse_mode: 'HTML' };
                if(kb) body.reply_markup = JSON.stringify(kb);
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            },
            sendTgToUser: (chatId, m) => fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: chatId, text: m, parse_mode: 'HTML' }) })
        };

        const bank = {
            send: () => {
                const targetQuery = document.getElementById('tr-target').value.toLowerCase().trim(), val = parseInt(document.getElementById('tr-val').value), u = state.user;
                if(!targetQuery || !val || val <= 0) return alert("–û—à–∏–±–∫–∞");
                const target = state.all.find(x => String(x.telegramId) === targetQuery || x.name.toLowerCase() === targetQuery);
                if(!target || target.fbKey === u.fbKey) return alert("–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                if(u.balance < val) return alert("–ù–µ—Ç –¥–µ–Ω–µ–≥");
                
                const histRef = rtdb.ref(`history/${u.fbKey}`).push();
                histRef.set({ title: '–ü–µ—Ä–µ–≤–æ–¥: ' + target.name, val: val, type: 'minus', ico: '‚è≥', status: 'wait' });
                
                const kb = { inline_keyboard: [[{ text: "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", url: `${window.location.href}?action=approve&to=${target.fbKey}&from=${u.fbKey}&val=${val}&hid=${histRef.key}` }, { text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", url: `${window.location.href}?action=decline&from=${u.fbKey}&hid=${histRef.key}` }]]};
                logic.sendTg(`üîî <b>–ú–û–î–ï–†–ê–¶–ò–Ø</b>\n–û—Ç: ${u.name}\n–ö–æ–º—É: ${target.name}\n–°—É–º–º–∞: ${val}‚ÇΩ`, kb);
                
                view.showSuccess("–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ", val + " ‚ÇΩ", "–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
                document.getElementById('tr-target').value = ""; document.getElementById('tr-val').value = "";
            },
            loan: () => {
                const s = parseInt(document.getElementById('ln-val').value), u = state.user;
                if(!s || s <= 0) return alert("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É");
                
                const histRef = rtdb.ref(`history/${u.fbKey}`).push();
                histRef.set({ title: '–ó–∞—è–≤–∫–∞ Gold', val: s, type: 'plus', ico: 'üåü', status: 'wait' });
                
                const kb = { inline_keyboard: [[{ text: "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", url: `${window.location.href}?action=loan_approve&from=${u.fbKey}&val=${s}&hid=${histRef.key}` }, { text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", url: `${window.location.href}?action=decline&from=${u.fbKey}&hid=${histRef.key}` }]]};
                logic.sendTg(`üåü <b>–ö–†–ï–î–ò–¢ GOLD</b>\n–ö–ª–∏–µ–Ω—Ç: ${u.name}\n–°—É–º–º–∞: ${s}‚ÇΩ`, kb);
                
                view.showSuccess("–ó–∞—è–≤–∫–∞ —É—à–ª–∞", s + " ‚ÇΩ", "–û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è –±–∞–Ω–∫–∞");
                document.getElementById('ln-val').value = "";
            },
            openScanner: () => {
                document.getElementById('qr-screen').style.display = 'block';
                scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                    if(text.startsWith('konline_pay:')) {
                        const amount = parseInt(text.split(':')[1]);
                        bank.closeScanner(); bank.showQrPayment(amount);
                    }
                }).catch(() => alert("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"));
            },
            closeScanner: () => { if(scanner) scanner.stop().then(() => { document.getElementById('qr-screen').style.display = 'none'; }); },
            showQrPayment: (val) => {
                document.getElementById('qr-pay-sum').innerText = val + " ‚ÇΩ";
                document.getElementById('modal-qr-pay').style.display = 'flex';
                document.getElementById('confirm-qr-btn').onclick = () => bank.processQrPay(val);
            },
            processQrPay: (val) => {
                const u = state.user; if(u.balance < val) return alert("–ú–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤!");
                rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance - val }).then(() => {
                    rtdb.ref('current_check').update({ status: 'paid' });
                    rtdb.ref(`history/${u.fbKey}`).push({ title: '–û–ø–ª–∞—Ç–∞ QR', val: val, type: 'minus', ico: 'üì±', status: 'done' });
                    document.getElementById('modal-qr-pay').style.display = 'none';
                    view.showSuccess("–û–ø–ª–∞—á–µ–Ω–æ", val + " ‚ÇΩ", "–ß–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª");
                });
            },
            exchange: () => {
                const amt = parseFloat(document.getElementById('ex-val').value), cost = Math.round(amt*91.2), u = state.user;
                if(!amt || u.balance < cost) return alert("–ú–∞–ª–æ –±–∞–ª–∞–Ω—Å–∞");
                rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance-cost, usd: (u.usd||0)+amt });
                rtdb.ref(`history/${u.fbKey}`).push({ title: '–ü–æ–∫—É–ø–∫–∞ $', val: amt, unit: '$', type: 'minus', ico: 'üíµ', status: 'done' });
                view.showSuccess("–û–±–º–µ–Ω", amt+" $", "–°–ø–∏—Å–∞–Ω–æ " + cost + " ‚ÇΩ");
            }
        };
        window.onload = () => logic.init();
    </script>
</body>
</html>
