<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö-–û–Ω–ª–∞–π–Ω PRO</title>
    <meta name="apple-mobile-web-app-title" content="–ö-–û–Ω–ª–∞–π–Ω">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --bg-body: #f0f4f8;
            --grad-red: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --grad-pay: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --white: #ffffff;
            --danger: #ff3b30;
            --radius-card: 28px;
            --radius-btn: 22px;
            --anim-screen: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-body); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; -webkit-font-smoothing: antialiased; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        .screen { display: none; position: absolute; inset: 0; overflow-y: auto; background: var(--bg-body); z-index: 10; opacity: 0; transform: scale(0.96); transition: opacity var(--anim-screen), transform var(--anim-screen); }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }

        /* Auth screens */
        #screen-pin-entry, #screen-otp-entry { background: var(--grad-red); color: white; display:none; flex-direction: column; justify-content: space-between; align-items: center; padding: 80px 30px 50px; }
        .auth-wrap { padding: 80px 30px; text-align: center; min-height: 100vh; background: #fff; }
        .logo-text { font-size: 52px; font-weight: 900; background: linear-gradient(45deg, #ff0000, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; letter-spacing: -2px; }

        .pin-dots { display: flex; gap: 15px; margin: 40px 0; }
        .p-dot { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; }
        .p-dot.active { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }

        .otp-input-group { display: flex; gap: 8px; justify-content: center; margin-top: 30px; }
        .otp-box { width: 45px; height: 55px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; }
        .otp-box.active { border-color: #ffcc00; box-shadow: 0 0 10px rgba(255,204,0,0.3); }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 300px; margin-top: 20px; }
        .k-btn { height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(5px); cursor: pointer; }
        .k-btn:active { background: rgba(255,255,255,0.3); }

        /* Main app styles */
        .header-top { background: var(--grad-red); padding: 60px 0 40px; border-radius: 0 0 50px 50px; color: white; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .user-meta { display: flex; justify-content: space-between; padding: 0 30px; align-items: center; margin-bottom: 25px; }
        .ava-box { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; border: 2px solid rgba(255,255,255,0.3); position: relative; }
        .santa-hat { position: absolute; top: -20px; left: -10px; font-size: 30px; transform: rotate(-15deg); }
        .scan-trigger { width: 45px; height: 45px; background: var(--grad-pay); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

        .cards-row { display: flex; overflow-x: auto; padding: 10px 30px 30px; gap: 15px; scrollbar-width: none; }
        .v-card { min-width: 220px; height: 135px; border-radius: var(--radius-card); padding: 25px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 15px 30px rgba(0,0,0,0.3); flex-shrink: 0; }
        .c-black { background: linear-gradient(160deg, #1a1a1a 0%, #000 100%); color: white; }
        .c-blue { background: linear-gradient(160deg, #002f6c 0%, #001433 100%); color: white; }
        .c-gold { background: linear-gradient(160deg, #d4af37 0%, #f1c40f 100%); color: #4a3b00; }

        .widget { background: #fff; border-radius: 24px; padding: 20px; margin: 15px 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .w-ico { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

        /* History items */
        .h-item { background: #fff; border-radius: 20px; padding: 18px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border-left: 5px solid transparent; }
        .h-ico { font-size: 24px; min-width: 48px; height: 48px; background: #f1f3f5; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        .h-info { flex: 1; overflow: hidden; }
        .h-name { font-size: 16px; font-weight: 700; color: #222; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .h-status { font-size: 12px; margin-top: 3px; font-weight: 500; }
        .h-sum { font-weight: 800; font-size: 17px; text-align: right; min-width: 80px; }
        
        .sum-neg { color: #000; }
        .sum-pos { color: #2ecc71; }
        .st-wait { color: #f39c12; }
        .st-done { color: #95a5a6; }

        input, textarea { width: 100%; height: 60px; border-radius: 18px; border: 1px solid #eee; padding: 0 20px; font-size: 17px; margin-bottom: 15px; background: #f9f9f9; font-family: inherit; }
        .btn-main { width: 100%; height: 60px; border: none; border-radius: var(--radius-btn); font-size: 17px; font-weight: 700; cursor: pointer; }
        .btn-black { background: #000; color: #fff; }
        .btn-pay { background: var(--grad-pay); color: white; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(10px); padding: 20px; }
        .modal-in { background: #fff; width: 100%; max-width: 340px; border-radius: 35px; padding: 35px; text-align: center; }
        .modal-pay { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); color: white; }

        .history-trigger { position: absolute; top: 60px; right: 85px; font-size: 26px; cursor: pointer; z-index: 100; color: white; opacity: 0.8; }
        #qr-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>

    <div id="qr-screen">
        <div id="reader"></div>
        <button onclick="bank.closeScanner()" style="position:fixed; bottom:50px; left:50%; transform:translateX(-50%); padding:15px 40px; border-radius:20px; background:white; border:none; font-weight:800; z-index:10001;">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="modal-qr-pay" class="modal">
        <div class="modal-in modal-pay">
            <div style="font-size:50px; margin-bottom:10px;">üí≥</div>
            <h2>–û–ø–ª–∞—Ç–∞ QR</h2>
            <div id="qr-pay-sum" style="font-size:48px; font-weight:900; margin:15px 0;">0 ‚ÇΩ</div>
            <button class="btn-main btn-pay" id="confirm-qr-btn">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
            <div onclick="document.getElementById('modal-qr-pay').style.display='none'" style="margin-top:20px; opacity:0.6;">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

    <div id="modal-success" class="modal">
        <div class="modal-in">
            <div style="font-size:60px; margin-bottom:15px;">üéÑ</div>
            <h2 id="suc-h">–ì–æ—Ç–æ–≤–æ!</h2>
            <div id="suc-val" style="font-size:32px; font-weight:900; margin:10px 0;">0 ‚ÇΩ</div>
            <p id="suc-p" style="color:#888; margin-bottom:25px;"></p>
            <button class="btn-main btn-black" onclick="view.hideSuccess()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-wrap">
            <h1 class="logo-text">–ö-–û–Ω–ª–∞–π–Ω</h1>
            <p style="color:#888; margin: 10px 0 40px;">–í–≤–µ–¥–∏—Ç–µ Telegram ID ‚ùÑÔ∏è</p>
            <input type="number" id="auth-tg-id" placeholder="ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1234567)">
            <button class="btn-main btn-black" onclick="logic.requestOTP()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
            <p style="margin-top:25px; color:#666;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="color:#007aff; cursor:pointer; font-weight:600;" onclick="view.nav('screen-register')">–°–æ–∑–¥–∞—Ç—å</span></p>
        </div>
    </div>

    <div id="screen-register" class="screen">
        <div style="padding:60px 25px;">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-auth')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="number" id="reg-tg-id" placeholder="Telegram ID">
            <input type="text" id="reg-name" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="password" id="reg-pin" placeholder="–ü–ò–ù (4 —Ü–∏—Ñ—Ä—ã)" maxlength="4">
            <button class="btn-main btn-black" onclick="logic.registerRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>

    <div id="screen-otp-entry" class="screen">
        <div style="text-align:center;">
            <h2>–í—Ö–æ–¥</h2>
            <p style="opacity:0.7;">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç–æ–º</p>
            <div class="otp-input-group">
                <div class="otp-box" id="otp-0"></div><div class="otp-box" id="otp-1"></div><div class="otp-box" id="otp-2"></div>
                <div class="otp-box" id="otp-3"></div><div class="otp-box" id="otp-4"></div><div class="otp-box" id="otp-5"></div>
            </div>
        </div>
        <div class="keypad">
            <div class="k-btn" onclick="logic.tapOtp('1')">1</div><div class="k-btn" onclick="logic.tapOtp('2')">2</div><div class="k-btn" onclick="logic.tapOtp('3')">3</div>
            <div class="k-btn" onclick="logic.tapOtp('4')">4</div><div class="k-btn" onclick="logic.tapOtp('5')">5</div><div class="k-btn" onclick="logic.tapOtp('6')">6</div>
            <div class="k-btn" onclick="logic.tapOtp('7')">7</div><div class="k-btn" onclick="logic.tapOtp('8')">8</div><div class="k-btn" onclick="logic.tapOtp('9')">9</div>
            <div class="k-btn" onclick="view.nav('screen-auth')">‚Üê</div><div class="k-btn" onclick="logic.tapOtp('0')">0</div><div class="k-btn" onclick="logic.tapOtp('DEL')">‚å´</div>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div style="text-align:center;">
            <h2 id="pin-user-name">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
            <div class="pin-dots">
                <div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div>
            </div>
        </div>
        <div class="keypad">
            <div class="k-btn" onclick="logic.tapPin('1')">1</div><div class="k-btn" onclick="logic.tapPin('2')">2</div><div class="k-btn" onclick="logic.tapPin('3')">3</div>
            <div class="k-btn" onclick="logic.tapPin('4')">4</div><div class="k-btn" onclick="logic.tapPin('5')">5</div><div class="k-btn" onclick="logic.tapPin('6')">6</div>
            <div class="k-btn" onclick="logic.tapPin('7')">7</div><div class="k-btn" onclick="logic.tapPin('8')">8</div><div class="k-btn" onclick="logic.tapPin('9')">9</div>
            <div class="k-btn" onclick="view.nav('screen-otp-entry')">‚Üê</div><div class="k-btn" onclick="logic.tapPin('0')">0</div><div class="k-btn" onclick="logic.tapPin('DEL')">‚å´</div>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="header-top">
            <div class="history-trigger" onclick="view.nav('screen-history')">üìÉ</div>
            <div class="user-meta">
                <div>
                    <div id="h-name" style="font-size:24px; font-weight:900;">---</div>
                    <div id="h-tg" style="font-size:12px; opacity:0.6;">ID: ---</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="scan-trigger" onclick="bank.openScanner()">üì∑</div>
                    <div class="ava-box"><span class="santa-hat">üéÖ</span><span id="h-ava">?</span></div>
                </div>
            </div>
            <div class="cards-row" id="h-cards"></div>
        </div>
        <div class="widget" onclick="view.nav('screen-transfer')">
            <div class="w-ico" style="background:#fff0f0; color:#e74c3c;">üéÅ</div>
            <div style="flex:1;"><b>–ü–µ—Ä–µ–≤–æ–¥—ã</b><div style="font-size:12px; color:#aaa;">–î—Ä—É–∑—å—è–º –ø–æ ID</div></div>
        </div>
        <div class="widget" onclick="view.nav('screen-exchange')">
            <div class="w-ico" style="background:#e3f2fd; color:#3498db;">üíµ</div>
            <div style="flex:1;"><b>–û–±–º–µ–Ω –≤–∞–ª—é—Ç</b><div id="w-usd">0.00 $</div></div>
        </div>
        <div class="widget" onclick="view.nav('screen-history')">
            <div class="w-ico" style="background:#f8f9fa; color:#333;">üìä</div>
            <div style="flex:1;"><b>–ò—Å—Ç–æ—Ä–∏—è</b><div style="font-size:12px; color:#aaa;">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div></div>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div style="padding:60px 25px 30px;">
            <div style="font-size:30px; margin-bottom:15px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:34px; font-weight:900; margin-bottom:25px;">–û–ø–µ—Ä–∞—Ü–∏–∏</h2>
            <div id="full-history-list"></div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding:60px 25px;">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–ü–µ—Ä–µ–≤–æ–¥ üéÑ</h2>
            <input type="text" id="tr-target" placeholder="ID –∏–ª–∏ –ò–º—è">
            <input type="number" id="tr-val" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
            <textarea id="tr-msg" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            <button class="btn-main btn-black" onclick="bank.send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="screen-exchange" class="screen">
        <div style="padding:60px 25px;">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–û–±–º–µ–Ω ‚ùÑÔ∏è</h2>
            <div style="text-align:center; padding:30px; background:#fff; border-radius:30px;">
                <div style="font-size:42px; font-weight:900;">91.20 ‚ÇΩ</div>
                <p style="color:#aaa;">–ö—É—Ä—Å –∑–∞ 1 $</p>
                <input type="number" id="ex-val" placeholder="–ö–æ–ª-–≤–æ $">
                <button class="btn-main btn-black" onclick="bank.exchange()">–ö—É–ø–∏—Ç—å USD</button>
            </div>
        </div>
    </div>

    <script>
        const TG_TOKEN = '8548215166:AAGVqNJxcZe_2bzWiaJIAFz57WRsIYjZQpM'; 
        const TG_ADMIN_ID = '7597506775';
        const FB_CONF = { apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", projectId: "webapp-b7149" };
        
        firebase.initializeApp(FB_CONF);
        const rtdb = firebase.database();

        let state = { all: [], user: null, pin: "", otp: "", generatedOtp: "" };
        let scanner = null;

        // Snow animation
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<60; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*2+1, v: Math.random()*1+0.4 });
        function drawSnow() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "rgba(255,255,255,0.7)"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); }); ctx.fill();
            flakes.forEach(f => { f.y += f.v; if(f.y > canvas.height) f.y = -5; }); requestAnimationFrame(drawSnow);
        }
        drawSnow();

        const view = {
            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    setTimeout(() => { if(!s.classList.contains('active')) s.style.display='none'; }, 400);
                });
                const t = document.getElementById(id);
                t.style.display = (id.includes('entry')) ? 'flex' : 'block';
                setTimeout(() => t.classList.add('active'), 50);
                if(id === 'screen-history') view.renderHistory();
            },
            updateDash: () => {
                if(!state.user) return;
                const u = state.user;
                document.getElementById('h-name').innerText = u.name;
                document.getElementById('h-tg').innerText = 'ID: ' + u.telegramId;
                document.getElementById('h-ava').innerText = u.name[0].toUpperCase();
                document.getElementById('w-usd').innerText = (u.usd || 0).toFixed(2) + " $";
                
                let html = `<div class="v-card c-black"><div>MIR Physical</div><div style="font-size:24px; font-weight:800;">${(u.balance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                if(u.usd > 0) html += `<div class="v-card c-blue"><div>Digital USD</div><div style="font-size:24px; font-weight:800;">${u.usd.toFixed(2)} $</div></div>`;
                document.getElementById('h-cards').innerHTML = html;
            },
            renderHistory: () => {
                const list = document.getElementById('full-history-list');
                list.innerHTML = '<p style="text-align:center; padding:20px; color:#aaa;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
                
                rtdb.ref(`history/${state.user.fbKey}`).on('value', snap => {
                    const data = snap.val();
                    if(!data) { list.innerHTML = '<div style="text-align:center; margin-top:50px; color:#bbb;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>'; return; }
                    
                    let html = '';
                    const items = Object.keys(data).reverse();
                    items.forEach(key => {
                        const h = data[key];
                        const isPlus = h.type === 'plus';
                        const statusText = h.status === 'wait' ? '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' : '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                        const statusClass = h.status === 'wait' ? 'st-wait' : 'st-done';
                        
                        html += `
                            <div class="h-item">
                                <div class="h-ico">${h.ico || 'üí≥'}</div>
                                <div class="h-info">
                                    <div class="h-name">${h.title}</div>
                                    <div class="h-status ${statusClass}">${statusText}</div>
                                </div>
                                <div class="h-sum ${isPlus?'sum-pos':'sum-neg'}">
                                    ${isPlus?'+':'-'}${h.val.toLocaleString()} ${h.unit || '‚ÇΩ'}
                                </div>
                            </div>
                        `;
                    });
                    list.innerHTML = html;
                });
            },
            showSuccess: (h, v, p) => {
                document.getElementById('suc-h').innerText = h;
                document.getElementById('suc-val').innerText = v;
                document.getElementById('suc-p').innerText = p;
                document.getElementById('modal-success').style.display = 'flex';
            },
            hideSuccess: () => {
                document.getElementById('modal-success').style.display='none';
                view.nav('screen-home');
            }
        };

        const logic = {
            init: () => {
                // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ª—É—à–∞—Ç–µ–ª—å –±–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
                rtdb.ref('clients').on('value', s => {
                    const d = s.val();
                    state.all = d ? Object.keys(d).map(k=>({...d[k], fbKey:k})) : [];
                    if(state.user) {
                        state.user = state.all.find(u => u.fbKey === state.user.fbKey);
                        view.updateDash();
                    }
                });

                // –°–ª—É—à–∞—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥ –∏–∑ URL (–¥–ª—è –∞–¥–º–∏–Ω–∞)
                const url = new URLSearchParams(window.location.search);
                if(url.get('action') === 'reg_approve') {
                    const id = url.get('id'), name = decodeURIComponent(url.get('name')), pin = url.get('pin');
                    rtdb.ref('clients').push({ telegramId: id, name: name, clientPin: pin, balance: 1000, usd: 0 }).then(() => {
                        logic.sendBot(id, `‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –í–∞—à –ü–ò–ù: ${pin}`);
                        window.location.href = window.location.pathname;
                    });
                }
                
                if(url.get('action') === 'approve_tr') {
                    const from = url.get('from'), to = url.get('to'), val = parseInt(url.get('val')), hid = url.get('hid');
                    rtdb.ref('clients').once('value', snap => {
                        const d = snap.val();
                        if(d[from].balance >= val) {
                            rtdb.ref(`clients/${from}`).update({ balance: d[from].balance - val });
                            rtdb.ref(`clients/${to}`).update({ balance: (d[to].balance || 0) + val });
                            rtdb.ref(`history/${from}/${hid}`).update({ status: 'done', ico: 'üéÅ' });
                            rtdb.ref(`history/${to}`).push({ title: '–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç ' + d[from].name, val: val, type: 'plus', ico: 'üí∞', status: 'done' });
                            window.location.href = window.location.pathname;
                        }
                    });
                }
            },
            requestOTP: () => {
                const id = document.getElementById('auth-tg-id').value;
                const user = state.all.find(u => String(u.telegramId) === String(id));
                if(!user) return alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ");
                
                state.user = user;
                state.generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                state.otp = ""; logic.drawOtp();
                
                logic.sendBot(id, `‚ùÑÔ∏è –í–∞—à –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥: ${state.generatedOtp}`);
                view.nav('screen-otp-entry');
            },
            tapOtp: (v) => {
                if(v === 'DEL') state.otp = state.otp.slice(0, -1);
                else if(state.otp.length < 6) state.otp += v;
                logic.drawOtp();
                if(state.otp === state.generatedOtp) { state.pin = ""; view.nav('screen-pin-entry'); }
            },
            tapPin: (v) => {
                if(v === 'DEL') state.pin = state.pin.slice(0, -1);
                else if(state.pin.length < 4) state.pin += v;
                logic.drawPin();
                if(state.pin.length === 4) {
                    if(state.pin === String(state.user.clientPin)) {
                        view.updateDash();
                        view.nav('screen-home');
                    } else {
                        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥");
                        state.pin = ""; logic.drawPin();
                    }
                }
            },
            drawOtp: () => {
                for(let i=0; i<6; i++) {
                    const b = document.getElementById(`otp-${i}`);
                    b.innerText = state.otp[i] || "";
                    b.classList.toggle('active', i === state.otp.length);
                }
            },
            drawPin: () => {
                document.querySelectorAll('.p-dot').forEach((d,i) => d.classList.toggle('active', i < state.pin.length));
            },
            registerRequest: () => {
                const id = document.getElementById('reg-tg-id').value, name = document.getElementById('reg-name').value, pin = document.getElementById('reg-pin').value;
                if(!id || !name || !pin) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
                const url = `${window.location.href}?action=reg_approve&id=${id}&name=${encodeURIComponent(name)}&pin=${pin}`;
                logic.sendAdmin(`üÜï –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:\n–ò–º—è: ${name}\nID: ${id}\n–ü–ò–ù: ${pin}`, { inline_keyboard: [[{ text: "–û–î–û–ë–†–ò–¢–¨", url: url }]] });
                alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω—É!"); view.nav('screen-auth');
            },
            sendAdmin: (m, kb) => fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: TG_ADMIN_ID, text: m, reply_markup: kb }) }),
            sendBot: (id, m) => fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: id, text: m }) })
        };

        const bank = {
            send: () => {
                const query = document.getElementById('tr-target').value.toLowerCase().trim(), val = parseInt(document.getElementById('tr-val').value), u = state.user;
                const target = state.all.find(x => String(x.telegramId) === query || x.name.toLowerCase() === query);
                if(!target || !val || u.balance < val) return alert("–û—à–∏–±–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –±–∞–ª–∞–Ω—Å");
                
                const hid = rtdb.ref(`history/${u.fbKey}`).push({ title: '–ü–µ—Ä–µ–≤–æ–¥ ' + target.name, val: val, type: 'minus', ico: '‚è≥', status: 'wait' }).key;
                const url = `${window.location.href}?action=approve_tr&from=${u.fbKey}&to=${target.fbKey}&val=${val}&hid=${hid}`;
                
                logic.sendAdmin(`üí∏ –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥:\n–û—Ç: ${u.name}\n–ö–æ–º—É: ${target.name}\n–°—É–º–º–∞: ${val}‚ÇΩ`, { inline_keyboard: [[{ text: "–ü–û–î–¢–í–ï–†–î–ò–¢–¨", url: url }]] });
                view.showSuccess("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞", val + " ‚ÇΩ", "–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º");
            },
            exchange: () => {
                const amt = parseFloat(document.getElementById('ex-val').value), cost = Math.round(amt * 91.2), u = state.user;
                if(!amt || u.balance < cost) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
                
                rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance - cost, usd: (u.usd||0) + amt });
                rtdb.ref(`history/${u.fbKey}`).push({ title: '–ü–æ–∫—É–ø–∫–∞ –≤–∞–ª—é—Ç—ã', val: amt, unit: '$', type: 'plus', ico: 'üíµ', status: 'done' });
                view.showSuccess("–£—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω", amt + " $", "–°–ø–∏—Å–∞–Ω–æ " + cost + " ‚ÇΩ");
            },
            openScanner: () => {
                document.getElementById('qr-screen').style.display = 'block';
                scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                    if(text.includes('konline_pay:')) {
                        bank.closeScanner();
                        const val = parseInt(text.split(':')[1]);
                        document.getElementById('qr-pay-sum').innerText = val + " ‚ÇΩ";
                        document.getElementById('modal-qr-pay').style.display = 'flex';
                        document.getElementById('confirm-qr-btn').onclick = () => {
                            if(state.user.balance < val) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
                            rtdb.ref(`clients/${state.user.fbKey}`).update({ balance: state.user.balance - val });
                            rtdb.ref(`history/${state.user.fbKey}`).push({ title: '–û–ø–ª–∞—Ç–∞ –ø–æ QR', val: val, type: 'minus', ico: 'üì±', status: 'done' });
                            document.getElementById('modal-qr-pay').style.display = 'none';
                            view.showSuccess("–û–ø–ª–∞—á–µ–Ω–æ", val + " ‚ÇΩ", "–ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ");
                        };
                    }
                });
            },
            closeScanner: () => { if(scanner) scanner.stop().then(() => document.getElementById('qr-screen').style.display = 'none'); }
        };

        window.onload = logic.init;
    </script>
</body>
</html>
